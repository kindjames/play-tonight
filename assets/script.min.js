var spotifyLive=function(e,t){"use strict";function o(e){return!e||0===e.length}var n=e.echoNest=e.echoNest||{};var r="TADM7C6U9DKHCUBJD";var i="";var s=750;var u=function(e){t.post("http://developer.echonest.com/api/v4/tasteprofile/create",{api_key:r,format:"json",type:"artist",name:(new Date).getTime()},function(t){typeof e==="function"&&e(t.response.id)})};var a=function(e){var t=[];_.each(e,function(e){if(e.tracks&&e.tracks.length>0){t.push(e.tracks[0].foreign_id)}});return t};n.getTasteProfileId=function(e){if(o(i)){u(e)}else{typeof e==="function"&&e(i)}};n.uploadArtistsToTasteProfile=function(e,i){n.getTasteProfileId(function(n){var o=_.map(e,function(e){e.artist_id="songkick:artist:"+e.artist_id;return{action:"update",item:e}});console.log("Adding "+o.length+" artists to Taste Profile (id: "+n+").");t.post("http://developer.echonest.com/api/v4/tasteprofile/update",{api_key:r,format:"json",id:n,data:JSON.stringify(o)},function(){setTimeout(function(){typeof i==="function"&&i(n);t(document).trigger("taste-profile-completed",n);console.log("Artists added to EchoNest Taste Profile (id: "+n+").")},s)})})};n.getTasteProfile=function(e,n){function s(e){var t=e.response.catalog.items.length;console.log("Received response containing "+e.response.catalog.items.length+" artists.");i=i.concat(e.response.catalog.items);if(t<this.resultsPerPage){typeof n==="function"&&n(i)}else{o(this.index+t,this.apiKey,this.tasteProfileId,this.resultsPerPage)}}console.log("Contacting EchoNest API for Taste Profile (id: "+e+")...");var i=[];var o=function(e,n,r,i){console.log(" -> index "+e+"...");t.ajax({url:"http://developer.echonest.com/api/v4/tasteprofile/read",data:{api_key:n,id:r,bucket:["terms","id:spotify-WW","hotttnesss"],results:i,start:e},apiKey:n,index:e,resultsPerPage:i,tasteProfileId:r,traditional:true}).done(s)};o(0,r,e,100)};n.getPopularSongsForArtists=function(e,n){var i=[];t.each(e,function(s,o){console.log("Getting most popular songs for "+o.name+"...");t.ajax({url:"http://developer.echonest.com/api/v4/song/search",data:{api_key:r,bucket:["tracks","id:spotify-WW","song_hotttnesss"],artist_id:o.id,sort:"song_hotttnesss-desc",limit:true,results:3},cache:true,traditional:true}).done(function(t){var r=a(t.response.songs);console.log("Received "+r.length+" song id's for "+o.name);i.push(r);if(s+1==e.length){typeof n==="function"&&n(_.flatten(i))}})})};return e}(spotifyLive||{},jQuery);var spotifyLive=function(e,t){"use strict";function s(e,t,n){this.longitude=e;this.latitude=t;this.accuracy=n}function u(e,t){this.city=e;this.country=t}var n=e.location=e.location||{};var r=null;var i=null;var o=function(e,n,r){var i=e.filter(function(e,r){return t.inArray(n,e.types)!==-1});return r?i[0].short_name:i[0].long_name};n.getCurrentCoordinates=function(e,n){if(!!i){typeof e==="function"&&e(coords)}else{console.log("Attempting to obtain coordinates...");var r={enableHighAccuracy:true,timeout:5e3,maximumAge:0};var o=function(n){var r=new s(n.coords.longitude,n.coords.latitude,n.coords.accuracy);console.log(r);typeof e==="function"&&e(r);t(document).trigger("coordinates-found",r)};if(navigator.geolocation){navigator.geolocation.getCurrentPosition(o,n,r)}else{typeof e==="function"&&n()}}};n.getCurrentCityAndCountryFromCoordinates=function(e,n){if(!!r){typeof n==="function"&&n(r)}else{console.log("Calling Google Geo Code API... (Lat:"+e.latitude+", Long:"+e.longitude+")");t.getJSON("http://maps.googleapis.com/maps/api/geocode/json",{latlng:e.latitude+","+e.longitude,sensor:false},function(e){r=new u(o(e.results[0].address_components,"postal_town",true),o(e.results[0].address_components,"country",false));console.log("Found area to be "+r.city+" in "+r.country);t(document).trigger("area-found",r);typeof n==="function"&&n(r)})}};n.getCurrentCityAndCountry=function(e){if(!!r){typeof e==="function"&&e(r)}else{n.getCurrentCoordinates(function(t){n.getCurrentCityAndCountryFromCoordinates(t,e)})}};return e}(spotifyLive||{},jQuery);var spotifyLive=function(e,t){"use strict";function r(e,t,n){function r(e,t){this.artist_name=e;this.eventIds=t}this.addEventId=function(e){this.item_keyvalues.eventIds.push(e.toString())};this.artist_id=e;this.item_keyvalues=new r(t,[n.toString()])}var n=e.util=e.util||{};n.dateToYMD=function(e){var t=e.getDate();var n=e.getMonth()+1;var r=e.getFullYear();return""+r+"-"+(n<=9?"0"+n:n)+"-"+(t<=9?"0"+t:t)};n.convertSongKickEventsToTasteProfileArtists=function(e){console.log("Converting "+e.length+" SongKick events to EchoNest Taste Profile artists...");var t=[];_.each(e,function(e){_.each(e.performance,function(n){var i=_.where(t,{artist_id:n.artist.id});if(i.length==0){t.push(new r(n.artist.id,n.artist.displayName,e.id))}else{console.log("Duplicate found - "+n.artist.displayName);i[0].addEventId(e.id)}})});return t};n.extractUsableArtists=function(e){var t=_.filter(e,function(e){return _.has(e,"foreign_ids")&&_.has(e,"terms")&&e.terms.length>0});console.log("Extracted "+t.length+" 'usuable' artists from "+e.length+".");return t};n.getTermDataFromArtistCollection=function(e){var t=[];_.chain(e).map(function(e){var t=_.chain(e.terms).filter(function(e){return e.frequency>.4}).pluck("name").value();return{id:e.foreign_ids[0].foreign_id,name:e.artist_name,terms:t}}).each(function(e){_.each(e.terms,function(n){if(!_.has(t,n)){t[n]=[]}t[n].push({id:e.id,name:e.name})})});return t};return e}(spotifyLive||{},jQuery);var spotifyLive=function(e,t){"use strict";var n=e.songKick=e.songKick||{};n.getAllEvents=function(e,n,r){function f(e){console.log(" -> page "+e+"...");t.ajax({url:"http://api.songkick.com/api/3.0/events.json",dataType:"jsonp",data:{apikey:a,location:"geo:"+o.latitude+","+o.longitude,min_date:s,max_date:s,page:e},context:this,currentPage:e,jsonp:"jsoncallback",success:l})}function l(e){var n=e.resultsPage.totalEntries;var r=e.resultsPage.page;var i=e.resultsPage.perPage;if(n==0){t(document).trigger("no-local-events-found");console.log("No events found.")}else{console.log("Received response of page "+r+" containing "+e.resultsPage.results.event.length+" events.");u=u.concat(e.resultsPage.results.event);if(r*i<n){f(this.currentPage+1)}else{t(document).trigger("all-local-events-found",{events:u})}}}var i=n,s=spotifyLive.util.dateToYMD(n),o=r,u=[],a=e;f(1)};return e}(spotifyLive||{},jQuery);var spotifyLive=function(e,t){"use strict";var n=e.view=e.view||{};var r=3;var i=[];n.controls={root:t(document),parentContainer:t("#container"),screensContainer:t("#screens-container"),allScreens:t("#screens-container > div"),findArtistsButton:t("#find-artists-button"),makePlaylistButton:t("#make-playlist-button"),backButton:t("#back-button"),notificationModal:t("#notification-modal"),loadingAnimation:t("#bar-loader"),termGrid:t("#term-grid"),loaderLabel:t("#notification-label"),landingScreen:t("#landing-screen"),termScreen:t("#term-screen"),playerScreen:t("#player-screen"),playerContainer:t("#spotify-player")};n.controlActions={setLoaderLabel:function(e){n.controls.loaderLabel.fadeOut("fast",function(){t(this).text(e).fadeIn("fast")})},setErrorLabel:function(e){n.controls.loaderLabel.fadeOut("fast",function(){n.controls.loadingAnimation.hide();t(this).text(e).fadeIn("fast")})},showLoadingScreen:function(e){n.controls.screensContainer.fadeOut(function(){n.controlActions.setLoaderLabel(e);n.controls.notificationModal.fadeIn()})},hideLoadingScreen:function(e){n.controls.notificationModal.fadeOut(e).hide()},showScreen:function(e,t){n.controls.screensContainer.fadeOut(function(){n.controlActions.hideLoadingScreen(function(){n.controls.allScreens.removeClass("active").hide();e.addClass("active").show();n.controls.screensContainer.fadeIn("fast",t)})})}};n.actions={init:function(){n.controlActions.showScreen(n.controls.allScreens.first());n.controls.findArtistsButton.on("click",n.actions.onFindArtistsClick);n.controls.makePlaylistButton.on("click",n.actions.onMakePlaylistClick);n.controls.backButton.on("click",n.actions.onBackClick);n.controls.root.on("coordinates-found",n.actions.onCoordinatesFound);n.controls.root.on("all-local-events-found",n.actions.onAllEventsFound);n.controls.root.on("taste-profile-completed",n.actions.onTasteProfileUploaded);n.controls.root.on("no-local-events-found",n.actions.onNoLocalEventsFound)},onFindArtistsClick:function(){n.controlActions.showLoadingScreen("Finding your location...");spotifyLive.location.getCurrentCoordinates()},onMakePlaylistClick:function(){n.controlActions.showLoadingScreen("Finding songs...");var e=t("li.selected",n.controls.termGrid).text();spotifyLive.echoNest.getPopularSongsForArtists(i[e],function(t){spotifyLive.location.getCurrentCityAndCountry(function(r){var i=o(e)+" in "+r.city+" tonight.";n.displaySpotifyTrackset(t,i);n.controlActions.showScreen(n.controls.playerScreen)})})},onBackClick:function(){n.controlActions.showScreen(n.controls.termScreen,function(){n.removeSpotifyTrackset()})},onCoordinatesFound:function(e,t){n.controlActions.setLoaderLabel("Looking for events...");spotifyLive.location.getCurrentCityAndCountryFromCoordinates(t);console.log("Contacting SongKick API for artists playing locally tonight...");spotifyLive.songKick.getAllEvents("qnqepvaYb1LXkz0T",new Date,t)},onAllEventsFound:function(e,t){spotifyLive.location.getCurrentCityAndCountry(function(e){var n=spotifyLive.util.convertSongKickEventsToTasteProfileArtists(t.events);spotifyLive.echoNest.uploadArtistsToTasteProfile(n)})},onNoLocalEventsFound:function(e,t){n.controlActions.setErrorLabel("Seems no one's playing in town tonight :(")},onTasteProfileUploaded:function(e,t){spotifyLive.echoNest.getTasteProfile(t,n.actions.processTasteProfile)},processTasteProfile:function(e){var t=spotifyLive.util.extractUsableArtists(e);if(t.length>0){n.controlActions.setLoaderLabel("Getting metadata on "+t.length+" artists...");i=spotifyLive.util.getTermDataFromArtistCollection(t);s(i,15);n.controlActions.showScreen(n.controls.termScreen)}else{n.controlActions.setErrorLabel("Seems no one's playing in town tonight :(")}}};var s=function(e,r){var i=_.chain(e).pairs().sortBy(function(e){return e[1].length}).last(r).map(function(e){var t=_.pluck(e[1],"name").join("\r\n");return"<li data-toggle=tooltip title='"+t+"'><span>"+e[0]+"</span></li>"}).value().reverse().join("");n.controls.termGrid.html(i).fadeIn();t("li",n.controls.termGrid).on("click",function(){n.controls.makePlaylistButton.prop("disabled",false);var e=t(this);var r=t("#term-grid li.selected");if(r.text()!=e.text()){r.removeClass("selected");e.addClass("selected")}}).tooltip()};var o=function(e,t){e=t?e.toLowerCase():e;return e.replace(/(\b)([a-zA-Z])/,function(e){return e.toUpperCase()})};n.displaySpotifyTrackset=function(e,t){var r=_.map(e,function(e){return e.replace("spotify-WW:track:","")});n.controls.playerContainer.html('<iframe src="https://embed.spotify.com/?uri=spotify:trackset:'+t+":"+r.join(",")+'" width="300" height="380" frameborder="0" allowtransparency="true"></iframe>')};n.removeSpotifyTrackset=function(){n.controls.playerContainer.html("")};return e}(spotifyLive||{},jQuery)