var spotifyLive=(function(h,d){var i=h.echoNest=h.echoNest||{};var f="TADM7C6U9DKHCUBJD";var a="";var e=750;function c(j){return(!j||0===j.length)}var g=function(j){d.post("http://developer.echonest.com/api/v4/tasteprofile/create",{api_key:f,format:"json",type:"artist",name:new Date().getTime()},function(k){typeof j==="function"&&j(k.response.id)})};var b=function(j){var k=[];_.each(j,function(l){if(l.tracks&&l.tracks.length>0){k.push(l.tracks[0].foreign_id)}});return k};i.getTasteProfileId=function(j){if(c(a)){g(j)}else{typeof j==="function"&&j(a)}};i.uploadArtistsToTasteProfile=function(k,j){i.getTasteProfileId(function(m){var l=_.map(k,function(n){n.artist_id="songkick:artist:"+n.artist_id;return{action:"update",item:n}});console.log("Adding "+l.length+" artists to Taste Profile (id: "+m+").");d.post("http://developer.echonest.com/api/v4/tasteprofile/update",{api_key:f,format:"json",id:m,data:JSON.stringify(l)},function(){setTimeout(function(){typeof j==="function"&&j(m);d(document).trigger("taste-profile-completed",m);console.log("Artists added to EchoNest Taste Profile (id: "+m+").")},e)})})};i.getTasteProfile=function(m,k){console.log("Contacting EchoNest API for Taste Profile (id: "+m+")...");var j=[];function n(p){var o=p.response.catalog.items.length;console.log("Received response containing "+p.response.catalog.items.length+" artists.");j=j.concat(p.response.catalog.items);if(o<this.resultsPerPage){typeof k==="function"&&k(j)}else{l((this.index+o),this.apiKey,this.tasteProfileId,this.resultsPerPage)}}var l=function(p,r,q,o){console.log(" -> index "+p+"...");d.ajax({url:"http://developer.echonest.com/api/v4/tasteprofile/read",data:{api_key:r,id:q,bucket:["terms","id:spotify-WW","hotttnesss"],results:o,start:p},apiKey:r,index:p,resultsPerPage:o,tasteProfileId:q,traditional:true}).done(n)};l(0,f,m,100)};i.getPopularSongsForArtists=function(k,j){var l=[];d.each(k,function(n,m){console.log("Getting most popular songs for "+m.name+"...");d.ajax({url:"http://developer.echonest.com/api/v4/song/search",data:{api_key:f,bucket:["tracks","id:spotify-WW","song_hotttnesss"],artist_id:m.id,sort:"song_hotttnesss-desc",limit:true,results:3},cache:true,traditional:true}).done(function(o){var p=b(o.response.songs);console.log("Received "+p.length+" song id's for "+m.name);l.push(p);if((n+1)==k.length){typeof j==="function"&&j(_.flatten(l))}})})};return h}(spotifyLive||{},jQuery));var spotifyLive=(function(d,f){var b=d.location=d.location||{};var e=null;var g=null;function a(i,k,j){this.longitude=i;this.latitude=k;this.accuracy=j}var h=function(k,j,l){var i=k.filter(function(n,m){return(f.inArray(j,n.types)!==-1)});return l?i[0].short_name:i[0].long_name};function c(j,i){this.city=j;this.country=i}b.getCurrentCoordinates=function(i,j){if(!!g){typeof i==="function"&&i(coords)}else{console.log("Attempting to obtain coordinates...");var k={enableHighAccuracy:true,timeout:5000,maximumAge:0};var l=function(m){var n=new a(m.coords.longitude,m.coords.latitude,m.coords.accuracy);console.log(n);typeof i==="function"&&i(n);f(document).trigger("coordinates-found",n)};if(navigator.geolocation){navigator.geolocation.getCurrentPosition(l,j,k)}else{typeof i==="function"&&j()}}};b.getCurrentCityAndCountryFromCoordinates=function(j,i){if(!!e){typeof i==="function"&&i(e)}else{console.log("Calling Google Geo Code API... (Lat:"+j.latitude+", Long:"+j.longitude+")");f.getJSON("http://maps.googleapis.com/maps/api/geocode/json",{latlng:j.latitude+","+j.longitude,sensor:false},function(k){e=new c(h(k.results[0].address_components,"postal_town",true),h(k.results[0].address_components,"country",false));console.log("Found area to be "+e.city+" in "+e.country);f(document).trigger("area-found",e);typeof i==="function"&&i(e)})}};b.getCurrentCityAndCountry=function(i){if(!!e){typeof i==="function"&&i(e)}else{b.getCurrentCoordinates(function(j){b.getCurrentCityAndCountryFromCoordinates(j,i)})}};return d}(spotifyLive||{},jQuery));var spotifyLive=(function(b,c){var a=b.songKick=b.songKick||{};a.getAllEvents=function(h,g,j){var m=g,i=spotifyLive.util.dateToYMD(g),l=j,e=[],d=h;function k(n){console.log(" -> page "+n+"...");c.ajax({url:"http://api.songkick.com/api/3.0/events.json",dataType:"jsonp",data:{apikey:d,location:"geo:"+l.latitude+","+l.longitude,min_date:i,max_date:i,page:n},context:this,currentPage:n,jsonp:"jsoncallback",success:f})}function f(q){var n=q.resultsPage.totalEntries;var p=q.resultsPage.page;var o=q.resultsPage.perPage;if(n==0){c(document).trigger("no-local-events-found");console.log("No events found.")}else{console.log("Received response of page "+p+" containing "+q.resultsPage.results.event.length+" events.");e=e.concat(q.resultsPage.results.event);if(p*o<n){k(this.currentPage+1)}else{c(document).trigger("all-local-events-found",{events:e})}}}k(1)};return b}(spotifyLive||{},jQuery));var spotifyLive=(function(b,c){var a=b.util=b.util||{};function d(g,e,f){function h(j,i){this.artist_name=j;this.eventIds=i}this.addEventId=function(i){this.item_keyvalues.eventIds.push(i.toString())};this.artist_id=g;this.item_keyvalues=new h(e,[f.toString()])}a.dateToYMD=function(f){var g=f.getDate();var e=f.getMonth()+1;var h=f.getFullYear();return""+h+"-"+(e<=9?"0"+e:e)+"-"+(g<=9?"0"+g:g)};a.convertSongKickEventsToTasteProfileArtists=function(f){console.log("Converting "+f.length+" SongKick events to EchoNest Taste Profile artists...");var e=[];_.each(f,function(g){_.each(g.performance,function(i){var h=_.where(e,{artist_id:i.artist.id});if(h.length==0){e.push(new d(i.artist.id,i.artist.displayName,g.id))}else{console.log("Duplicate found - "+i.artist.displayName);h[0].addEventId(g.id)}})});return e};a.extractUsableArtists=function(e){var f=_.filter(e,function(g){return _.has(g,"foreign_ids")&&_.has(g,"terms")&&g.terms.length>0});console.log("Extracted "+f.length+" 'usuable' artists from "+e.length+".");return f};a.getTermDataFromArtistCollection=function(e){var f=[];_.chain(e).map(function(g){var h=_.chain(g.terms).filter(function(i){return i.frequency>0.4}).pluck("name").value();return{id:g.foreign_ids[0].foreign_id,name:g.artist_name,terms:h}}).each(function(g){_.each(g.terms,function(h){if(!_.has(f,h)){f[h]=[]}f[h].push({id:g.id,name:g.name})})});return f};return b}(spotifyLive||{},jQuery));var spotifyLive=(function(c,d){var b=c.view=c.view||{};var a=3;var g=[];b.controls={root:d(document),parentContainer:d("#container"),screensContainer:d("#screens-container"),allScreens:d("#screens-container > div"),findArtistsButton:d("#find-artists-button"),makePlaylistButton:d("#make-playlist-button"),backButton:d("#back-button"),notificationModal:d("#notification-modal"),loadingAnimation:d("#bar-loader"),termGrid:d("#term-grid"),loaderLabel:d("#notification-label"),landingScreen:d("#landing-screen"),termScreen:d("#term-screen"),playerScreen:d("#player-screen"),playerContainer:d("#spotify-player")};b.controlActions={setLoaderLabel:function(h){b.controls.loaderLabel.fadeOut("fast",function(){d(this).text(h).fadeIn("fast")})},setErrorLabel:function(h){b.controls.loaderLabel.fadeOut("fast",function(){b.controls.loadingAnimation.hide();d(this).text(h).fadeIn("fast")})},showLoadingScreen:function(h){b.controls.screensContainer.fadeOut(function(){b.controlActions.setLoaderLabel(h);b.controls.notificationModal.fadeIn()})},hideLoadingScreen:function(h){b.controls.notificationModal.fadeOut(h).hide()},showScreen:function(h,i){b.controls.screensContainer.fadeOut(function(){b.controlActions.hideLoadingScreen(function(){b.controls.allScreens.removeClass("active").hide();h.addClass("active").show();b.controls.screensContainer.fadeIn("fast",i)})})}};b.actions={init:function(){b.controlActions.showScreen(b.controls.allScreens.first());b.controls.findArtistsButton.on("click",b.actions.onFindArtistsClick);b.controls.makePlaylistButton.on("click",b.actions.onMakePlaylistClick);b.controls.backButton.on("click",b.actions.onBackClick);b.controls.root.on("coordinates-found",b.actions.onCoordinatesFound);b.controls.root.on("all-local-events-found",b.actions.onAllEventsFound);b.controls.root.on("taste-profile-completed",b.actions.onTasteProfileUploaded);b.controls.root.on("no-local-events-found",b.actions.onNoLocalEventsFound)},onFindArtistsClick:function(){b.controlActions.showLoadingScreen("Finding your location...");spotifyLive.location.getCurrentCoordinates()},onMakePlaylistClick:function(){b.controlActions.showLoadingScreen("Finding songs...");var h=d("li.selected",b.controls.termGrid).text();spotifyLive.echoNest.getPopularSongsForArtists(g[h],function(i){spotifyLive.location.getCurrentCityAndCountry(function(j){var k=e(h)+" in "+j.city+" tonight.";b.displaySpotifyTrackset(i,k);b.controlActions.showScreen(b.controls.playerScreen)})})},onBackClick:function(){b.controlActions.showScreen(b.controls.termScreen,function(){b.removeSpotifyTrackset()})},onCoordinatesFound:function(h,i){spotifyLive.location.getCurrentCityAndCountryFromCoordinates(i,function(j){b.controlActions.setLoaderLabel("Looking for events in "+j.city+"...");console.log("Contacting SongKick API for artists playing locally tonight...");spotifyLive.songKick.getAllEvents("qnqepvaYb1LXkz0T",new Date(),i)})},onAllEventsFound:function(h,i){spotifyLive.location.getCurrentCityAndCountry(function(k){var j=spotifyLive.util.convertSongKickEventsToTasteProfileArtists(i.events);spotifyLive.echoNest.uploadArtistsToTasteProfile(j)})},onNoLocalEventsFound:function(h,i){b.controlActions.setErrorLabel("Seems no one's playing in town tonight :(")},onTasteProfileUploaded:function(h,i){spotifyLive.echoNest.getTasteProfile(i,b.actions.processTasteProfile)},processTasteProfile:function(i){var h=spotifyLive.util.extractUsableArtists(i);if(h.length>0){b.controlActions.setLoaderLabel("Getting metadata on "+h.length+" artists...");g=spotifyLive.util.getTermDataFromArtistCollection(h);f(g,15);b.controlActions.showScreen(b.controls.termScreen)}else{b.controlActions.setErrorLabel("Seems no one's playing in town tonight :(")}}};var f=function(i,h){var j=_.chain(i).pairs().sortBy(function(k){return k[1].length}).last(h).map(function(k){var l=_.pluck(k[1],"name").join("\r\n");return"<li data-toggle=tooltip title='"+l+"'><span>"+k[0]+"</span></li>"}).value().reverse().join("");b.controls.termGrid.html(j).fadeIn();d("li",b.controls.termGrid).on("click",function(){b.controls.makePlaylistButton.prop("disabled",false);var l=d(this);var k=d("#term-grid li.selected");if(k.text()!=l.text()){k.removeClass("selected");l.addClass("selected")}}).tooltip()};var e=function(i,h){i=h?i.toLowerCase():i;return i.replace(/(\b)([a-zA-Z])/,function(j){return j.toUpperCase()})};b.displaySpotifyTrackset=function(h,i){var j=_.map(h,function(k){return k.replace("spotify-WW:track:","")});b.controls.playerContainer.html('<iframe src="https://embed.spotify.com/?uri=spotify:trackset:'+i+":"+j.join(",")+'" width="300" height="380" frameborder="0" allowtransparency="true"></iframe>')};b.removeSpotifyTrackset=function(){b.controls.playerContainer.html("")};return c}(spotifyLive||{},jQuery));