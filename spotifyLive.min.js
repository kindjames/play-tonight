var spotifyLive=function(a,b){"use strict";function g(a){return!a||0===a.length}var c=a.echoNest=a.echoNest||{},d="TADM7C6U9DKHCUBJD",e="",f=500,h=function(a){b.post("http://developer.echonest.com/api/v4/tasteprofile/create",{api_key:d,format:"json",type:"artist",name:(new Date).getTime()},function(b){"function"==typeof a&&a(b.response.id)})},i=function(a){var b=[];return _.each(a,function(a){a.tracks&&a.tracks.length>0&&b.push(a.tracks[0].foreign_id)}),b};return c.getTasteProfileId=function(a){g(e)?h(a):"function"==typeof a&&a(e)},c.uploadArtistsToTasteProfile=function(a,e){c.getTasteProfileId(function(c){var g=_.map(a,function(a){return a.artist_id="songkick:artist:"+a.artist_id,{action:"update",item:a}});spotifyLive.util.debug("Adding "+g.length+" artists to Taste Profile (id: "+c+")."),b.post("http://developer.echonest.com/api/v4/tasteprofile/update",{api_key:d,format:"json",id:c,data:JSON.stringify(g)},function(){setTimeout(function(){"function"==typeof e&&e(c),b(document).trigger("taste-profile-completed",c),spotifyLive.util.debug("Artists added to EchoNest Taste Profile (id: "+c+").")},f)})})},c.getTasteProfile=function(a,c){function f(a){var b=a.response.catalog.items.length;spotifyLive.util.debug("Received response containing "+a.response.catalog.items.length+" artists."),e=e.concat(a.response.catalog.items),b<this.resultsPerPage?"function"==typeof c&&c(e):g(this.index+b,this.apiKey,this.tasteProfileId,this.resultsPerPage)}spotifyLive.util.debug("Contacting EchoNest API for Taste Profile (id: "+a+")...");var e=[],g=function(a,c,d,e){spotifyLive.util.debug(" -> index "+a+"..."),b.ajax({url:"http://developer.echonest.com/api/v4/tasteprofile/read",data:{api_key:c,id:d,bucket:["terms","id:spotify-WW","hotttnesss"],results:e,start:a},apiKey:c,index:a,resultsPerPage:e,tasteProfileId:d,traditional:!0}).done(f)};g(0,d,a,100)},c.getPopularSongsForArtists=function(a,c,e){var f=[],g=10,h=3;b.each(a,function(j,k){spotifyLive.util.debug("Getting "+h+" most popular songs for "+k.name+"..."),b.ajax({url:"http://developer.echonest.com/api/v4/song/search",data:{api_key:d,bucket:["tracks","id:spotify-WW","song_hotttnesss"],artist_id:k.id,sort:"song_hotttnesss-desc",limit:!0,results:h},cache:!0,traditional:!0}).done(function(b){var d=i(b.response.songs);spotifyLive.util.debug("Received "+d.length+" song id's for "+k.name),f.push(d),j+1==(a.length||g)&&"function"==typeof c&&c(_.flatten(f))}).error(function(){0==f.length?(spotifyLive.util.debug("Error retreiving song id's."),"function"==typeof e&&e()):(spotifyLive.util.debug("Error retreiving some id's - using what we've got."),"function"==typeof c&&c(_.flatten(f)))})})},a}(spotifyLive||{},jQuery),spotifyLive=function(a,b){"use strict";var c=a.songKick=a.songKick||{};return c.getAllEvents=function(a,c){function h(a){spotifyLive.util.debug(" -> page "+a+"..."),b.ajax({url:"http://api.songkick.com/api/3.0/events.json",dataType:"jsonp",data:{apikey:g,location:"clientip",min_date:e,max_date:e,page:a},context:this,currentPage:a,jsonp:"jsoncallback",success:i})}function i(a){var c=a.resultsPage.totalEntries,d=a.resultsPage.page,e=a.resultsPage.perPage;0==c?(b(document).trigger("no-local-events-found"),spotifyLive.util.debug("No events found.")):(spotifyLive.util.debug("Received response of page "+d+" containing "+a.resultsPage.results.event.length+" events."),f=f.concat(a.resultsPage.results.event),c>d*e?h(this.currentPage+1):b(document).trigger("all-local-events-found",{events:f}))}var e=spotifyLive.util.dateToYMD(c),f=[],g=a;h(1)},a}(spotifyLive||{},jQuery),spotifyLive=function(a){"use strict";function e(a,b,c){function d(a,b){this.artist_name=a,this.eventIds=b}this.addEventId=function(a){this.item_keyvalues.eventIds.push(a.toString())},this.artist_id=a,this.item_keyvalues=new d(b,[c.toString()])}var c=a.util=a.util||{},d={},f=function(a){d={city:a.displayName,country:a.country.displayName}};return c.getLocation=function(){return d},c.debug=function(a){console.log(a)},c.dateToYMD=function(a){var b=a.getDate(),c=a.getMonth()+1,d=a.getFullYear();return""+d+"-"+(9>=c?"0"+c:c)+"-"+(9>=b?"0"+b:b)},c.isTouchDevice=function(){return"ontouchstart"in window||navigator.MaxTouchPoints>0||navigator.msMaxTouchPoints>0},c.convertSongKickEventsToTasteProfileArtists=function(a){if(0==a.length)throw new Error("Cannot convert SK to EN profile: zero events");f(_.first(a).venue.metroArea),spotifyLive.util.debug("Converting "+a.length+" SongKick events to EchoNest Taste Profile artists...");var b=[];return _.each(a,function(a){_.each(a.performance,function(c){var d=_.where(b,{artist_id:c.artist.id});0==d.length?b.push(new e(c.artist.id,c.artist.displayName,a.id)):(spotifyLive.util.debug("Duplicate found - "+c.artist.displayName),d[0].addEventId(a.id))})}),b},c.extractUsableArtists=function(a){var b=_.filter(a,function(a){return _.has(a,"foreign_ids")&&_.has(a,"terms")&&a.terms.length>0});return spotifyLive.util.debug("Extracted "+b.length+" 'usuable' artists from "+a.length+"."),b},c.getTermDataFromArtistCollection=function(a){var b=[];return _.chain(a).map(function(a){var b=_.chain(a.terms).filter(function(a){return a.frequency>.4}).pluck("name").value();return{id:a.foreign_ids[0].foreign_id,name:a.artist_name,popularity:a.hotttnesss,terms:b}}).each(function(a){_.each(a.terms,function(c){_.has(b,c)||(b[c]=[]),b[c].push({id:a.id,popularity:a.popularity,name:a.name})})}),_.each(_.keys(b),function(a){b[a]=_.chain(b[a]).sortBy(function(a){return a.popularity}).last(8).value().reverse()}),b},a}(spotifyLive||{},jQuery),spotifyLive=function(a,b){"use strict";var c=a.view=a.view||{},e=[];c.controls={root:b(document),parentContainer:b("#container"),screensContainer:b("#screens-container"),allScreens:b("#screens-container > div > div"),findArtistsButton:b("#find-artists-button"),backButton:b("#back-button"),notificationModal:b("#notification-modal"),loadingAnimation:b("#bar-loader"),termGrid:b("#term-grid"),loaderLabel:b("#notification-label"),landingScreen:b("#landing-screen"),termScreen:b("#term-screen"),playerScreen:b("#player-screen"),playerContainer:b("#spotify-player")},c.controlActions={setLoaderLabel:function(a){c.controls.loaderLabel.fadeOut("fast",function(){b(this).text(a).fadeIn("fast")})},setErrorLabel:function(a){c.controls.loaderLabel.fadeOut("fast",function(){c.controls.loadingAnimation.hide(),b(this).text(a).fadeIn("fast")})},showLoadingScreen:function(a){c.controls.screensContainer.fadeOut(function(){c.controlActions.setLoaderLabel(a),c.controls.notificationModal.fadeIn()})},hideLoadingScreen:function(a){c.controls.notificationModal.fadeOut(a).hide()},showScreen:function(a,b){c.controls.screensContainer.fadeOut(function(){c.controlActions.hideLoadingScreen(function(){c.controls.allScreens.removeClass("active").hide(),a.addClass("active").show(),c.controls.screensContainer.fadeIn("fast",b)})})}},c.actions={init:function(){c.controlActions.showScreen(c.controls.allScreens.first()),c.controls.findArtistsButton.on("click",c.actions.onFindArtistsClick),c.controls.backButton.on("click",c.actions.onBackClick),c.controls.root.on("all-local-events-found",c.actions.onAllEventsFound),c.controls.root.on("taste-profile-completed",c.actions.onTasteProfileUploaded),c.controls.root.on("no-local-events-found",c.actions.onNoLocalEventsFound),c.controls.root.on("term-selected",c.actions.onTermSelected)},onFindArtistsClick:function(){c.controlActions.showLoadingScreen("Searching through the sounds of your city..."),spotifyLive.util.debug("Contacting SongKick API for artists playing locally tonight..."),spotifyLive.songKick.getAllEvents("qnqepvaYb1LXkz0T",new Date)},onTermSelected:function(a,b){c.controlActions.showLoadingScreen("Finding songs...");var d=b;spotifyLive.echoNest.getPopularSongsForArtists(e[d],function(a){var b=spotifyLive.util.getLocation(),e=g(d)+" in "+b.city+" tonight";c.displaySpotifyTrackset(a,e),c.controlActions.showScreen(c.controls.playerScreen)})},onBackClick:function(){c.controlActions.showScreen(c.controls.termScreen,function(){c.removeSpotifyTrackset()})},onAllEventsFound:function(a,b){var c=spotifyLive.util.convertSongKickEventsToTasteProfileArtists(b.events);spotifyLive.echoNest.uploadArtistsToTasteProfile(c)},onNoLocalEventsFound:function(){c.controlActions.setErrorLabel("Seems no one's playing in town tonight :(")},onTasteProfileUploaded:function(a,b){spotifyLive.echoNest.getTasteProfile(b,c.actions.processTasteProfile)},processTasteProfile:function(a){var b=spotifyLive.util.extractUsableArtists(a);b.length>0?(c.controlActions.setLoaderLabel("Getting metadata on "+b.length+" artists..."),e=spotifyLive.util.getTermDataFromArtistCollection(b),f(e,15),c.controlActions.showScreen(c.controls.termScreen)):c.controlActions.setErrorLabel("Seems no one's playing in town tonight :(")}};var f=function(a,d){var e=_.chain(a).pairs().sortBy(function(a){return a[1].length}).last(d).map(function(a){var b=_.pluck(a[1],"name").join("\r\n");return"<li data-toggle=tooltip title='"+b+"'><span>"+a[0]+"</span></li>"}).value().reverse().join("");c.controls.termGrid.html(e).fadeIn();var f=b("li",c.controls.termGrid).on("click",function(){spotifyLive.view.controls.root.trigger("term-selected",b(this).text())});spotifyLive.util.isTouchDevice()||f.tooltip({placement:"auto top"})},g=function(a,b){return a=b?a.toLowerCase():a,a.replace(/(\b)([a-zA-Z])/,function(a){return a.toUpperCase()})};return c.displaySpotifyTrackset=function(a,b){var d=_.map(a,function(a){return a.replace("spotify:track:","").replace("spotify-WW:track:","")});c.controls.playerContainer.html('<iframe src="https://embed.spotify.com/?uri=spotify:trackset:'+b+":"+d.join(",")+'" width="300" height="380" frameborder="0" allowtransparency="true"></iframe>')},c.removeSpotifyTrackset=function(){c.controls.playerContainer.html("")},a}(spotifyLive||{},jQuery);