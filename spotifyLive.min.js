var spotifyLive=(function(h,d){var i=h.echoNest=h.echoNest||{},f="TADM7C6U9DKHCUBJD",a="",e=500;function c(j){return(!j||0===j.length)}var g=function(j){d.post("http://developer.echonest.com/api/v4/tasteprofile/create",{api_key:f,format:"json",type:"artist",name:new Date().getTime()},function(k){typeof j==="function"&&j(k.response.id)})};var b=function(j){var k=[];_.each(j,function(l){if(l.tracks&&l.tracks.length>0){k.push(l.tracks[0].foreign_id)}});return k};i.getTasteProfileId=function(j){if(c(a)){g(j)}else{typeof j==="function"&&j(a)}};i.uploadArtistsToTasteProfile=function(k,j){i.getTasteProfileId(function(m){var l=_.map(k,function(n){n.artist_id="songkick:artist:"+n.artist_id;return{action:"update",item:n}});spotifyLive.util.debug("Adding "+l.length+" artists to Taste Profile (id: "+m+").");d.post("http://developer.echonest.com/api/v4/tasteprofile/update",{api_key:f,format:"json",id:m,data:JSON.stringify(l)},function(){setTimeout(function(){typeof j==="function"&&j(m);d(document).trigger("taste-profile-completed",m);spotifyLive.util.debug("Artists added to EchoNest Taste Profile (id: "+m+").")},e)})})};i.getTasteProfile=function(m,k){spotifyLive.util.debug("Contacting EchoNest API for Taste Profile (id: "+m+")...");var j=[];function n(p){var o=p.response.catalog.items.length;spotifyLive.util.debug("Received response containing "+p.response.catalog.items.length+" artists.");j=j.concat(p.response.catalog.items);if(o<this.resultsPerPage){typeof k==="function"&&k(j)}else{l((this.index+o),this.apiKey,this.tasteProfileId,this.resultsPerPage)}}var l=function(p,r,q,o){spotifyLive.util.debug(" -> index "+p+"...");d.ajax({url:"http://developer.echonest.com/api/v4/tasteprofile/read",data:{api_key:r,id:q,bucket:["terms","id:spotify-WW","hotttnesss"],results:o,start:p},apiKey:r,index:p,resultsPerPage:o,tasteProfileId:q,traditional:true}).done(n)};l(0,f,m,100)};i.getPopularSongsForArtists=function(k,j,m){var l=[],o=10,n=3;d.each(k,function(q,p){spotifyLive.util.debug("Getting "+n+" most popular songs for "+p.name+"...");d.ajax({url:"http://developer.echonest.com/api/v4/song/search",data:{api_key:f,bucket:["tracks","id:spotify-WW","song_hotttnesss"],artist_id:p.id,sort:"song_hotttnesss-desc",limit:true,results:n},cache:true,traditional:true}).done(function(r){var s=b(r.response.songs);spotifyLive.util.debug("Received "+s.length+" song id's for "+p.name);l.push(s);if((q+1)==(k.length||o)){typeof j==="function"&&j(_.flatten(l))}}).error(function(){if(l.length==0){spotifyLive.util.debug("Error retreiving song id's.");typeof m==="function"&&m()}else{spotifyLive.util.debug("Error retreiving some id's - using what we've got.");typeof j==="function"&&j(_.flatten(l))}})})};return h}(spotifyLive||{},jQuery));var spotifyLive=(function(b,c){var a=b.songKick=b.songKick||{};a.getAllEvents=function(k,i){var f=i,j=spotifyLive.util.dateToYMD(i),e=[],g=k;function h(l){spotifyLive.util.debug(" -> page "+l+"...");c.ajax({url:"http://api.songkick.com/api/3.0/events.json",dataType:"jsonp",data:{apikey:g,location:"clientip",min_date:j,max_date:j,page:l},context:this,currentPage:l,jsonp:"jsoncallback",success:d})}function d(o){var l=o.resultsPage.totalEntries,n=o.resultsPage.page,m=o.resultsPage.perPage;if(l==0){c(document).trigger("no-local-events-found");spotifyLive.util.debug("No events found.")}else{spotifyLive.util.debug("Received response of page "+n+" containing "+o.resultsPage.results.event.length+" events.");e=e.concat(o.resultsPage.results.event);if(n*m<l){h(this.currentPage+1)}else{c(document).trigger("all-local-events-found",{events:e})}}}h(1)};return b}(spotifyLive||{},jQuery));var spotifyLive=(function(c,e){var b=c.util=c.util||{},d={};function f(i,g,h){function j(l,k){this.artist_name=l;this.eventIds=k}this.addEventId=function(k){this.item_keyvalues.eventIds.push(k.toString())};this.artist_id=i;this.item_keyvalues=new j(g,[h.toString()])}var a=function(g){d={city:g.displayName,country:g.country.displayName}};b.getLocation=function(){return d};b.debug={};b.dateToYMD=function(h){var i=h.getDate(),g=h.getMonth()+1,j=h.getFullYear();return""+j+"-"+(g<=9?"0"+g:g)+"-"+(i<=9?"0"+i:i)};b.isTouchDevice=function(){return(("ontouchstart" in window)||(navigator.MaxTouchPoints>0)||(navigator.msMaxTouchPoints>0))};b.convertSongKickEventsToTasteProfileArtists=function(h){if(h.length==0){throw new Error("Cannot convert SK to EN profile: zero events")}a(_.first(h).venue.metroArea);spotifyLive.util.debug("Converting "+h.length+" SongKick events to EchoNest Taste Profile artists...");var g=[];_.each(h,function(i){_.each(i.performance,function(k){var j=_.where(g,{artist_id:k.artist.id});if(j.length==0){g.push(new f(k.artist.id,k.artist.displayName,i.id))}else{spotifyLive.util.debug("Duplicate found - "+k.artist.displayName);j[0].addEventId(i.id)}})});return g};b.extractUsableArtists=function(g){var h=_.filter(g,function(i){return _.has(i,"foreign_ids")&&_.has(i,"terms")&&i.terms.length>0});spotifyLive.util.debug("Extracted "+h.length+" 'usuable' artists from "+g.length+".");return h};b.getTermDataFromArtistCollection=function(g){var h=[];_.chain(g).map(function(i){var j=_.chain(i.terms).filter(function(k){return k.frequency>0.4}).pluck("name").value();return{id:i.foreign_ids[0].foreign_id,name:i.artist_name,popularity:i.hotttnesss,terms:j}}).each(function(i){_.each(i.terms,function(j){if(!_.has(h,j)){h[j]=[]}h[j].push({id:i.id,popularity:i.popularity,name:i.name})})});_.each(_.keys(h),function(i){h[i]=_.chain(h[i]).sortBy(function(j){return j.popularity}).last(8).value().reverse()});return h};return c}(spotifyLive||{},jQuery));var spotifyLive=(function(c,d){var b=c.view=c.view||{},a=3,g=[];b.controls={root:d(document),parentContainer:d("#container"),screensContainer:d("#screens-container"),allScreens:d("#screens-container > div > div"),findArtistsButton:d("#find-artists-button"),backButton:d("#back-button"),notificationModal:d("#notification-modal"),loadingAnimation:d("#bar-loader"),termGrid:d("#term-grid"),loaderLabel:d("#notification-label"),landingScreen:d("#landing-screen"),termScreen:d("#term-screen"),playerScreen:d("#player-screen"),playerContainer:d("#spotify-player")};b.controlActions={setLoaderLabel:function(h){b.controls.loaderLabel.fadeOut("fast",function(){d(this).text(h).fadeIn("fast")})},setErrorLabel:function(h){b.controls.loaderLabel.fadeOut("fast",function(){b.controls.loadingAnimation.hide();d(this).text(h).fadeIn("fast")})},showLoadingScreen:function(h){b.controls.screensContainer.fadeOut(function(){b.controlActions.setLoaderLabel(h);b.controls.notificationModal.fadeIn()})},hideLoadingScreen:function(h){b.controls.notificationModal.fadeOut(h).hide()},showScreen:function(h,i){b.controls.screensContainer.fadeOut(function(){b.controlActions.hideLoadingScreen(function(){b.controls.allScreens.removeClass("active").hide();h.addClass("active").show();b.controls.screensContainer.fadeIn("fast",i)})})}};b.actions={init:function(){b.controlActions.showScreen(b.controls.allScreens.first());b.controls.findArtistsButton.on("click",b.actions.onFindArtistsClick);b.controls.backButton.on("click",b.actions.onBackClick);b.controls.root.on("all-local-events-found",b.actions.onAllEventsFound);b.controls.root.on("taste-profile-completed",b.actions.onTasteProfileUploaded);b.controls.root.on("no-local-events-found",b.actions.onNoLocalEventsFound);b.controls.root.on("term-selected",b.actions.onTermSelected)},onFindArtistsClick:function(){b.controlActions.setLoaderLabel("Looking for local events...");spotifyLive.util.debug("Contacting SongKick API for artists playing locally tonight...");spotifyLive.songKick.getAllEvents("qnqepvaYb1LXkz0T",new Date())},onTermSelected:function(i,j){b.controlActions.showLoadingScreen("Finding songs...");var h=j;spotifyLive.echoNest.getPopularSongsForArtists(g[h],function(l){var k=spotifyLive.util.getLocation();var m=e(h)+" in "+k.city+" tonight";b.displaySpotifyTrackset(l,m);b.controlActions.showScreen(b.controls.playerScreen)})},onBackClick:function(){b.controlActions.showScreen(b.controls.termScreen,function(){b.removeSpotifyTrackset()})},onAllEventsFound:function(i,j){var h=spotifyLive.util.convertSongKickEventsToTasteProfileArtists(j.events);spotifyLive.echoNest.uploadArtistsToTasteProfile(h)},onNoLocalEventsFound:function(h,i){b.controlActions.setErrorLabel("Seems no one's playing in town tonight :(")},onTasteProfileUploaded:function(h,i){spotifyLive.echoNest.getTasteProfile(i,b.actions.processTasteProfile)},processTasteProfile:function(i){var h=spotifyLive.util.extractUsableArtists(i);if(h.length>0){b.controlActions.setLoaderLabel("Getting metadata on "+h.length+" artists...");g=spotifyLive.util.getTermDataFromArtistCollection(h);f(g,15);b.controlActions.showScreen(b.controls.termScreen)}else{b.controlActions.setErrorLabel("Seems no one's playing in town tonight :(")}}};var f=function(j,i){var k=_.chain(j).pairs().sortBy(function(l){return l[1].length}).last(i).map(function(l){var m=_.pluck(l[1],"name").join("\r\n");return"<li data-toggle=tooltip title='"+m+"'><span>"+l[0]+"</span></li>"}).value().reverse().join("");b.controls.termGrid.html(k).fadeIn();var h=d("li",b.controls.termGrid).on("click",function(){spotifyLive.view.controls.root.trigger("term-selected",d(this).text())});if(!spotifyLive.util.isTouchDevice()){h.tooltip({placement:"auto top"})}};var e=function(i,h){i=h?i.toLowerCase():i;return i.replace(/(\b)([a-zA-Z])/,function(j){return j.toUpperCase()})};b.displaySpotifyTrackset=function(h,i){var j=_.map(h,function(k){return k.replace("spotify-WW:track:","")});b.controls.playerContainer.html('<iframe src="https://embed.spotify.com/?uri=spotify:trackset:'+i+":"+j.join(",")+'" width="300" height="380" frameborder="0" allowtransparency="true"></iframe>')};b.removeSpotifyTrackset=function(){b.controls.playerContainer.html("")};return c}(spotifyLive||{},jQuery));